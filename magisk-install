#!/data/data/com.termux/files/usr/bin/bash

ui_print() {
  echo -e "\e[1;34m[STATUS]\e[0m - $1"
}

ui_success() {
  echo -e "\e[1;32m[SUCCESS]\e[0m - $1"
}

ui_error() {
  echo -e "\e[1;31m[ERROR]\e[0m - $1"
}

echo "---------------------------------------------------------------"
ui_print "WARNING: This process voids your warranty."
ui_print "The creator is NOT responsible for bricked devices."
ui_print "You are responsible for choosing correct images."
ui_print "Make sure your USB-OTG cable is connected properly and is stable."
ui_print "Also make sure the phone is fit for wiping user data and rooting."
echo "---------------------------------------------------------------"
echo ""
echo -n "- Do you accept these risks and have you verified your hardware? (yes/no): "
read -r confirm

if [[ "$confirm" != "yes" ]]; then
    ui_error "Process aborted by user."
    exit 1
fi

ui_print "Starting ADB Server..."
[span_1](start_span)adb start-server >/dev/null 2>&1[span_1](end_span)
ui_print "Checking for device..."
[span_2](start_span)if adb devices | grep -q -w "device"; then[span_2](end_span)
    ui_success "Device detected."
else
    ui_error "Device not found."
    [span_3](start_span)exit 1[span_3](end_span)
fi

ui_print "Rebooting to bootloader..."
adb reboot bootloader >/dev/null 2>&1

ui_print "Waiting for Fastboot..."
[span_4](start_span)until fastboot devices | grep -q "fastboot"; do[span_4](end_span)
    sleep 1
done
ui_success "Device is in Fastboot mode."

ui_print "Attempting to unlock bootloader..."
[span_5](start_span)ui_print "Check your phone screen to confirm the unlock!"[span_5](end_span)
[span_6](start_span)ui_print "Warning: This will erase all userdata."[span_6](end_span)
if fastboot flashing unlock; then
    ui_success "Unlock command sent successfully."
else
    [span_7](start_span)ui_error "Unlock failed. Ensure OEM Unlocking is enabled."[span_7](end_span)
    [span_8](start_span)exit 1[span_8](end_span)
fi

echo -n "- Enter path to vbmeta.img: "
read -r vbmetapath
vbmetapath=$(echo "$vbmetapath" | tr -d "'\"")

if [ -f "$vbmetapath" ]; then
    ui_print "Flashing vbmeta (Disabling Verity)..."
    if fastboot flash vbmeta --disable-verity --disable-verification "$vbmetapath" >/dev/null 2>&1; then
        ui_success "vbmeta flash successful!"
    else
        ui_error "vbmeta flash failed."
    fi
else
    ui_error "vbmeta file not found at: $vbmetapath"
fi

ui_print "Select target partition: (1: boot, 2: init_boot)"
read -r partition_choice
[span_9](start_span)if [ "$partition_choice" == "1" ]; then[span_9](end_span)
    target="boot"
else
    target="init_boot"
fi

ui_print "Enter path to the patched $target image:"
ui_print "Before you do this - make sure it is the correct device one"
read -r patched_image_path
patched_image_path=$(echo "$patched_image_path" | tr -d "'\"")

[span_10](start_span)if [ -f "$patched_image_path" ]; then[span_10](end_span)
    ui_print "Flashing $target image..."
    [span_11](start_span)if fastboot flash "$target" "$patched_image_path" >/dev/null 2>&1; then[span_11](end_span)
        [span_12](start_span)ui_success "$target flashed successfully!"[span_12](end_span)
    else
        [span_13](start_span)ui_error "Flash failed. Check if partition exists on this device."[span_13](end_span)
    fi
else
    [span_14](start_span)ui_error "Patched image not found at: $patched_image_path"[span_14](end_span)
fi

ui_success "Process finished."
[span_15](start_span)ui_print "Rebooting device to System..."[span_15](end_span)
fastboot reboot >/dev/null 2>&1
