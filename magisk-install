#!/data/data/com.termux/files/usr/bin/bash

# UI Functions with your original color scheme
ui_print() { echo -e "\e[1;34m[STATUS]\e[0m - $1"; }
ui_success() { echo -e "\e[1;32m[SUCCESS]\e[0m - $1"; }
ui_error() { echo -e "\e[1;31m[ERROR]\e[0m - $1"; }
ui_warn() { echo -e "\e[1;33m[WARNING]\e[0m - $1"; }

echo "---------------------------------------------------------------"
[span_1](start_span)ui_print "WARNING: This process voids your warranty."[span_1](end_span)
[span_2](start_span)ui_print "The creator is NOT responsible for bricked devices."[span_2](end_span)
[span_3](start_span)ui_print "Make sure your USB-OTG cable is stable."[span_3](end_span)
echo "---------------------------------------------------------------"

# --- NEW: OEM LOCKING WARNING ---
ui_warn "BOOTLOADER LOCK INFO:"
echo "1. Pixels and Global Xiaomis are usually unlockable."
echo "2. Samsung (US/Verizon/AT&T) often have PERMANENTLY LOCKED bootloaders."
echo "3. Huawei, Vivo, and Oppo are generally impossible to unlock."
echo "---------------------------------------------------------------"

echo -n "- Do you accept these risks and have you verified your hardware? (yes/no): "
read -r confirm

[span_4](start_span)if [[ "$confirm" != "yes" ]]; then[span_4](end_span)
    ui_error "Process aborted by user."
    exit 1
fi

ui_print "Starting ADB Server..."
[span_5](start_span)adb start-server >/dev/null 2>&1[span_5](end_span)

# --- NEW: SAMSUNG DETECTION ---
ui_print "Checking for Samsung devices..."
MANUFACTURER=$(adb shell getprop ro.product.manufacturer 2>/dev/null | tr -d '\r')
if [ "$MANUFACTURER" = "samsung" ] || [ "$MANUFACTURER" = "Samsung" ]; then
    ui_error "SAMSUNG DETECTED!"
    echo "Samsung devices use Download Mode (Odin/Heimdall), not Fastboot."
    echo "This script is for Fastboot-based devices (Pixel, Xiaomi, etc)."
    exit 1
fi

ui_print "Checking for device..."
[span_6](start_span)if adb devices | grep -q -w "device"; then[span_6](end_span)
    ui_success "Device detected."
else
    [span_7](start_span)ui_error "Device not found."[span_7](end_span)
    exit 1
fi

ui_print "Rebooting to bootloader..."
adb reboot bootloader >/dev/null 2>&1

ui_print "Waiting for Fastboot..."
[span_8](start_span)until fastboot devices | grep -q "fastboot"; do[span_8](end_span)
    sleep 1
done
ui_success "Device is in Fastboot mode."

[span_9](start_span)ui_print "Attempting to unlock bootloader..."[span_9](end_span)
ui_print "Check your phone screen to confirm the unlock!"
[span_10](start_span)if fastboot flashing unlock; then[span_10](end_span)
    ui_success "Unlock command sent successfully."
else
    ui_warn "Unlock failed. (This is normal if already unlocked or OEM Lock is on)."
fi

echo -n "- Enter path to vbmeta.img: "
read -r vbmetapath
vbmetapath=$(echo "$vbmetapath" | tr -d "'\"")

if [ -f "$vbmetapath" ]; then
    ui_print "Flashing vbmeta (Disabling Verity)..."
    fastboot flash vbmeta --disable-verity --disable-verification "$vbmetapath" >/dev/null 2>&1
    ui_success "vbmeta flash successful!"
else
    ui_warn "No vbmeta provided or found. Skipping..."
fi

# --- UPDATED: PARTITION MENU ---
ui_print "Select target partition:"
echo "1) boot (Standard)"
echo "2) init_boot (Modern Pixels/Android 13+)"
echo "3) recovery (Legacy/Older devices)"
read -r partition_choice

case $partition_choice in
    1) target="boot" ;;
    2) target="init_boot" ;;
    3) target="recovery" ;;
    *) ui_error "Invalid choice"; exit 1 ;;
esac

ui_print "Enter path to the patched $target image:"
read -r patched_image_path
[span_11](start_span)patched_image_path=$(echo "$patched_image_path" | tr -d "'\"")[span_11](end_span)

[span_12](start_span)if [ -f "$patched_image_path" ]; then[span_12](end_span)
    ui_print "Flashing $target image..."
    [span_13](start_span)if fastboot flash "$target" "$patched_image_path" >/dev/null 2>&1; then[span_13](end_span)
        [span_14](start_span)ui_success "$target flashed successfully!"[span_14](end_span)
    else
        [span_15](start_span)ui_error "Flash failed. Check if partition exists."[span_15](end_span)
    fi
else
    [span_16](start_span)ui_error "Patched image not found at: $patched_image_path"[span_16](end_span)
fi

ui_success "Process finished."
ui_print "Rebooting device to System..."
fastboot reboo
t >/dev/null 2>&1
