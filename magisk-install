#!/data/data/com.termux/files/usr/bin/bash

# UI Colors
RED='\e[1;31m'
GREEN='\e[1;32m'
YELLOW='\e[1;33m'
BLUE='\e[1;34m'
NC='\e[0m' # No Color

ui_print() { echo -e "${BLUE}[STATUS]${NC} $1"; }
ui_warn() { echo -e "${YELLOW}[WARNING]${NC} $1"; }
ui_error() { echo -e "${RED}[ERROR]${NC} $1"; }

ui_print "---------------------------------------------"
ui_print "- Open-Source Magisk Flash Tool             -"
ui_print "---------------------------------------------"

# --- THE BIG WARNING ---
ui_warn "IMPORTANT: BOOTLOADER LOCK INFO"
echo "1. Most Pixels and Global Xiaomis are unlockable."
echo "2. Samsung (US/Canada), Verizon, and AT&T models"
echo "   often have PERMANENTLY LOCKED bootloaders."
echo "3. Huawei and Vivo devices are generally locked tight."
ui_warn "If your bootloader cannot be unlocked, STOP NOW."
echo "---------------------------------------------"

ui_print "Starting ADB..."
adb start-server >/dev/null 2>&1

# Check for Samsung specifically
MANUFACTURER=$(adb shell getprop ro.product.manufacturer 2>/dev/null | tr -d '\r')
if [ "$MANUFACTURER" = "samsung" ] || [ "$MANUFACTURER" = "Samsung" ]; then
    ui_error "SAMSUNG DETECTED!"
    echo "Samsung devices do not use Fastboot. They use Download Mode."
    echo "This script is currently for Fastboot-based devices (Pixel, Xiaomi, etc)."
    echo "For Samsung, you need to use 'Heimdall' or 'Odin'."
    exit 1
fi

ui_print "Checking for device..."
if ! adb devices | grep -q -w "device"; then
    ui_error "No device found. Check USB-OTG connection and USB Debugging."
    exit 1
fi

ui_print "Rebooting to Bootloader..."
adb reboot bootloader >/dev/null 2>&1

ui_print "Waiting for Fastboot..."
until fastboot devices | grep -q "fastboot"; do
    sleep 1
done

ui_print "Attempting Bootloader Unlock (Standard)..."
ui_warn "This will FAIL if 'OEM Unlocking' isn't on in Settings."
fastboot flashing unlock || ui_error "Unlock failed! (Expected if already unlocked)"

ui_print "Select the partition to flash the patched image:"
echo "1) boot (Standard for most)"
echo "2) init_boot (Newer Pixels/Android 13+)"
echo "3) recovery (For some older devices)"
read -r part_choice

case $part_choice in
    1) target="boot" ;;
    2) target="init_boot" ;;
    3) target="recovery" ;;
    *) ui_error "Invalid choice"; exit 1 ;;
esac

ui_print "Drag and drop your patched image file here:"
read -r img_path
img_path=$(echo "$img_path" | tr -d "'\"")

if [ -f "$img_path" ]; then
    ui_warn "Flashing $img_path to $target..."
    ui_warn "Final chance to cancel (Ctrl+C)!"
    sleep 3
    fastboot flash "$target" "$img_path"
    fastboot reboot
    ui_print "Flash complete! Device is rebooting."
else
    ui_error "File not found! Path: 
$img_path"
fi
