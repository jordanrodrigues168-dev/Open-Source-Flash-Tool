#!/data/data/com.termux/files/usr/bin/bash

# UI Functions with your original color scheme
ui_print() { echo -e "\e[1;34m[STATUS]\e[0m - $1"; }
ui_success() { echo -e "\e[1;32m[SUCCESS]\e[0m - $1"; }
ui_error() { echo -e "\e[1;31m[ERROR]\e[0m - $1"; }
ui_warn() { echo -e "\e[1;33m[WARNING]\e[0m - $1"; }

echo "---------------------------------------------------------------"
ui_print "WARNING: This process voids your warranty."
ui_print "The creator is NOT responsible for bricked devices."
ui_print "Make sure your USB-OTG cable is stable."
echo "---------------------------------------------------------------"

# --- NEW: OEM LOCKING WARNING ---
ui_warn "BOOTLOADER LOCK INFO:"
echo "1. Pixels and Global Xiaomis are usually unlockable."
echo "2. Samsung (US/Verizon/AT&T) often have PERMANENTLY LOCKED bootloaders."
echo "3. Huawei, Vivo, and Oppo are generally impossible to unlock."
echo "---------------------------------------------------------------"

echo -n "- Do you accept these risks and have you verified your hardware? (yes/no): "
read -r confirm

if [[ "$confirm" != "yes" ]]; then
    ui_error "Process aborted by user."
    exit 1
fi

ui_print "Starting ADB Server..."
adb start-server >/dev/null 2>&1

# --- NEW: SAMSUNG DETECTION ---
ui_print "Checking for Samsung devices..."
MANUFACTURER=$(adb shell getprop ro.product.manufacturer 2>/dev/null | tr -d '\r')
if [ "$MANUFACTURER" = "samsung" ] || [ "$MANUFACTURER" = "Samsung" ]; then
    ui_error "SAMSUNG DETECTED!"
    echo "Samsung devices use Download Mode (Odin/Heimdall), not Fastboot."
    echo "This script is for Fastboot-based devices (Pixel, Xiaomi, etc)."
    exit 1
fi

ui_print "Checking for device..."
if adb devices | grep -q -w "device"; then
    ui_success "Device detected."
else
    ui_error "Device not found."
    exit 1
fi

ui_print "Rebooting to bootloader..."
adb reboot bootloader >/dev/null 2>&1

ui_print "Waiting for Fastboot..."
until fastboot devices | grep -q "fastboot"; do
    sleep 1
done
ui_success "Device is in Fastboot mode."

ui_print "Attempting to unlock bootloader..."
ui_print "Check your phone screen to confirm the unlock!"
if fastboot flashing unlock; then
    ui_success "Unlock command sent successfully."
else
    ui_warn "Unlock failed. (This is normal if already unlocked or OEM Lock is on)."
fi

echo -n "- Enter path to vbmeta.img: "
read -r vbmetapath
vbmetapath=$(echo "$vbmetapath" | tr -d "'\"")

if [ -f "$vbmetapath" ]; then
    ui_print "Flashing vbmeta (Disabling Verity)..."
    fastboot flash vbmeta --disable-verity --disable-verification "$vbmetapath" >/dev/null 2>&1
    ui_success "vbmeta flash successful!"
else
    ui_warn "No vbmeta provided or found. Skipping..."
fi

# --- UPDATED: PARTITION MENU ---
ui_print "Select target partition:"
echo "1) boot (Standard)"
echo "2) init_boot (Modern Pixels/Android 13+)"
echo "3) recovery (Legacy/Older devices)"
read -r partition_choice

case $partition_choice in
    1) target="boot" ;;
    2) target="init_boot" ;;
    3) target="recovery" ;;
    *) ui_error "Invalid choice"; exit 1 ;;
esac

ui_print "Enter path to the patched $target image:"
read -r patched_image_path
patched_image_path=$(echo "$patched_image_path" | tr -d "'\"")

if [ -f "$patched_image_path" ]; then
    ui_print "Flashing $target image..."
    if fastboot flash "$target" "$patched_image_path" >/dev/null 2>&1; then
        ui_success "$target flashed successfully!"
    else
        ui_error "Flash failed. Check if partition exists."
    fi
else
    ui_error "Patched image not found at: $patched_image_path"
fi

ui_success "Process finished."
ui_print "Rebooting device to System..."
fastboot reboo
t >/dev/null 2>&1
